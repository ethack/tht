<!doctype html><html lang=en class="js csstransforms3d"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.82.0"><link rel=alternate type=application/rss+xml href=https://ethack.github.io/tht/index.xml title="Threat Hunting Toolkit"><link rel=alternate type=application/json href=https://ethack.github.io/tht/index.json title="Threat Hunting Toolkit"><meta name=description content="Threat Hunting Toolkit"><meta name=author content="Ethan Robish"><link rel=icon href=/tht/images/favicon.png type=image/png><title>Introduction :: Threat Hunting Toolkit</title><link href=/tht/css/nucleus.css?1634970669 rel=stylesheet><link href=/tht/css/fontawesome-all.min.css?1634970669 rel=stylesheet><link href=/tht/css/featherlight.min.css?1634970669 rel=stylesheet><link href=/tht/css/perfect-scrollbar.min.css?1634970669 rel=stylesheet><link href=/tht/css/auto-complete.css?1634970669 rel=stylesheet><link href=/tht/css/theme.css?1634970669 rel=stylesheet><link href=/tht/css/tabs.css?1634970669 rel=stylesheet><link href=/tht/css/hugo-theme.css?1634970669 rel=stylesheet><link href=/tht/css/theme-blue.css?1634970669 rel=stylesheet><script src=/tht/js/jquery.min.js?1634970669></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}:not(pre)>code+span.copy-to-clipboard{display:none}</style><link href=/tht/css/custom.css?1634970669 rel=stylesheet><link href=/tht/css/highlightjs/rainbow.css?1634970669 rel=stylesheet></head><body data-url=/tht/><nav id=sidebar><div id=header-wrapper><div id=header><h3>Threat Hunting Toolkit</h3></div><div class=searchbox><label for=search-by><i class="fas fa-search"></i></label>
<input data-search-input id=search-by type=search placeholder=Search...>
<span data-search-clear><i class="fas fa-times"></i></span></div><script src=/tht/js/lunr.min.js?1634970669></script><script src=/tht/js/auto-complete.js?1634970669></script><script>var index_url="/tht/index.json",root_url="/",baseUri=root_url.replace(/\/$/,'')</script><script src=/tht/js/search.js?1634970669></script></div><div id=homelinks><ul><li><a class=padding href=/tht/><i class="fas fa-home"></i> Home</a></li></ul></div><div class=highlightable><ul class=topics><li data-nav-id=/tht/filter/ title=Filter class=dd-item><a href=/tht/filter/>Filter</a><ul><li data-nav-id=/tht/filter/chop/ title=Chop class=dd-item><a href=/tht/filter/chop/>Chop</a></li><li data-nav-id=/tht/filter/filter/ title=Filter class=dd-item><a href=/tht/filter/filter/>Filter</a></li></ul></li><li data-nav-id=/tht/summarize/ title=Summarize class=dd-item><a href=/tht/summarize/>Summarize</a><ul><li data-nav-id=/tht/summarize/conn-summary/ title="Conn Summary" class=dd-item><a href=/tht/summarize/conn-summary/>Conn Summary</a></li></ul></li><li data-nav-id=/tht/correlate/ title=Correlate class=dd-item><a href=/tht/correlate/>Correlate</a><ul></ul></li><li data-nav-id=/tht/visualize/ title=Visualize class=dd-item><a href=/tht/visualize/>Visualize</a><ul></ul></li><li data-nav-id=/tht/multipurpose/ title=Multipurpose class=dd-item><a href=/tht/multipurpose/>Multipurpose</a><ul></ul></li><li data-nav-id=/tht/utils/ title=Utils class=dd-item><a href=/tht/utils/>Utils</a><ul></ul></li><li data-nav-id=/tht/development/ title=Development class=dd-item><a href=/tht/development/>Development</a><ul></ul></li></ul><div id=footer><div id=copyright><p xmlns:cc=http://creativecommons.org/ns#>This work is licensed under <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/?ref=chooser-v1" target=_blank rel="license noopener noreferrer" style=display:inline-block>CC BY-NC-SA 4.0<img style=height:22px!important;margin-left:3px;vertical-align:text-bottom src="https://mirrors.creativecommons.org/presskit/icons/cc.svg?ref=chooser-v1"><img style=height:22px!important;margin-left:3px;vertical-align:text-bottom src="https://mirrors.creativecommons.org/presskit/icons/by.svg?ref=chooser-v1"><img style=height:22px!important;margin-left:3px;vertical-align:text-bottom src="https://mirrors.creativecommons.org/presskit/icons/nc.svg?ref=chooser-v1"><img style=height:22px!important;margin-left:3px;vertical-align:text-bottom src="https://mirrors.creativecommons.org/presskit/icons/sa.svg?ref=chooser-v1"></a></p></div></div></div></nav><div id=body><div id=overlay></div><div class="padding highlightable"><div id=head-tags></div><main id=body-inner><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i> navigation</a></span><h1 id=threat-hunting-toolkit>Threat Hunting Toolkit</h1><h4 id=you-have-data-now-what>You have data. Now what?</h4><p>Don&rsquo;t panic! You have many tools and methods at your disposal. This documentation will show how you can use and combine them to make your data more valuable.</p><ul><li><strong>Explore</strong><ul><li>The simplest thing you can do is explore your raw data. There may be too much at first to be meaningful, but viewing your data is necessary to determine how to transform and summarize it. In data science this is called <em>Exploratory Data Analysis</em> (EDA).<ul><li>Example: Using <code>cat</code> to view a log file or loading a CSV into a spreadsheet.</li></ul></li><li><em>Visualizing</em> your data through graphs and charts is a useful way to discover patterns and trends, identify outliers, and view relationships.</li></ul></li><li><strong>Filter</strong><ul><li>Reducing the amount of data through <em>filtering</em> is nearly always going to be your first step and often between other operations as well.</li><li>Not only does this remove noise irrelevant to your question or goal, but it decreases the time it takes to process the remaining data.</li><li>How to: Countless tools accomplish this in different ways. Anything that uses regular expressions, search terms, or comparisions is a way of filtering data. Common Linux utils like <code>grep</code> and <code>awk</code>, THT&rsquo;s <code>filter</code>, your SIEM&rsquo;s search bar, or even a SQL <code>WHERE</code> clause are all ways to accomplish this.</li></ul></li><li><strong>Compute</strong><ul><li>This is when you use fields from your existing data and perform some operation to create or <em>derive</em> a new field, sometimes referred to as a <em>computed field</em>. A simple example would be adding the bytes sent and received together to get the total bytes transferred. In data science this is known as <em>Feature Engineering</em>.</li><li><em>Computing</em> normally involves some custom programming, either in a formal language like Python, or in a domain specific language (DSL) in a tool like Miller.</li></ul></li><li><strong>Correlate</strong><ul><li>Closely related to pivoting, which is when you would manually use a piece of information to <em>pivot</em> into a different dataset. This can also be thought of as a <em>join</em>.</li><li>You can <em>correlate</em> your data with other data by <em>joining</em> datasets together on common fields.<ul><li>Example: Taking multiple log types that share a field (e.g. IP address) and joining them together to create a single entry containing data from both logs.</li></ul></li><li>You can also <em>enrich</em> your data using data from other sources, such as an API or existing database.<ul><li>Examples: Name resolution or passive DNS, geographical info, WHOIS or ownership info, or even threat intelligence feeds.</li></ul></li></ul></li><li><strong>Summarize</strong><ul><li><em>Summarizing</em>, also known as <em>grouping</em>, <em>aggregating</em>, or <em>data stacking</em>, reduces your data by combining data through methods such as the average, sum, or count.</li></ul></li></ul><h2 id=installing-tht>Installing THT</h2><p>The Threat Hunting Toolkit (THT) is the name of the project, a docker image, as well as a wrapper script for launching. While you can use the docker image manually, the recommended way is through the wrapper script.</p><p>This will install the <code>tht</code> script in <code>/usr/local/bin/tht</code>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo curl -o /usr/local/bin/tht https://raw.githubusercontent.com/ethack/tht/main/tht <span style=color:#f92672>&amp;&amp;</span> sudo chmod +x /usr/local/bin/tht
</code></pre></div><h2 id=running-tht>Running THT</h2><p>This is the simplest way to launch THT.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>tht
</code></pre></div><p>This will give you a <code>zsh</code> shell inside a new THT container. All the tools and examples from this documentation can now be used.</p><div class="notices tip"><div class=label>Tip</div><p>Your host&rsquo;s filesystem is accessible from <code>/host</code>.</p></div><h3 id=advanced-usage>Advanced Usage</h3><p>With <code>tht</code> you can also run one-off commands or even give it scripts to execute within the context of the container. This is useful if you want to automate or schedule certain tasks from the host system.</p><p>The basic usage is <code>tht run &lt;command></code>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>tht run <span style=color:#e6db74>&#34;echo hello world&#34;</span>
</code></pre></div><p><strong>Result:</strong></p><pre><code>hello world
</code></pre><p>This will run existing script.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>cat my_script.sh | tht run
</code></pre></div><p>You can also specify multiple commands or an entire script like this.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>tht run <span style=color:#e6db74>&lt;&lt;\SCRIPT
</span><span style=color:#e6db74>message=GREAT!
</span><span style=color:#e6db74>echo -n &#34;Running multiple commands &#34;
</span><span style=color:#e6db74>echo -n &#34;without escaping feels $message &#34;
</span><span style=color:#e6db74>echo {1..3}
</span><span style=color:#e6db74>SCRIPT</span>
</code></pre></div><p><strong>Result:</strong></p><pre><code>Running multiple commands without escaping feels GREAT! 1 2 3
</code></pre><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>tht run <span style=color:#e6db74>&lt;&lt;\SCRIPT
</span><span style=color:#e6db74>#!/usr/bin/env python3
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>print(&#39;Here is an example python program&#39;)
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>SCRIPT</span>
</code></pre></div><p><strong>Result:</strong></p><pre><code>Here is an example python program
</code></pre><p>You might want to put a script like this in your host&rsquo;s cron scheduler <code>/etc/cron.hourly/pdns</code>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e>#!/bin/bash
</span><span style=color:#75715e></span>
tht run <span style=color:#e6db74>&lt;&lt;\SCRIPT
</span><span style=color:#e6db74>cd /host/opt/zeek/logs/
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>nice flock -n &#34;/host/tmp/pdns.lock&#34; \
</span><span style=color:#e6db74>fd &#39;dns.*log&#39; | sort | xargs -n 24 bro-pdns index
</span><span style=color:#e6db74>SCRIPT</span>
</code></pre></div><p>See the <a href=https://github.com/ethack/tht/tree/main/cron>cron/</a> directory in the code repo for more examples of cron scripts.</p><h2 id=updating-tht>Updating THT</h2><p>This will pull the latest image as well as latest <code>tht</code> script.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>tht update
</code></pre></div><p><strong>Result:</strong></p><pre><code>Downloading latest THT image...
Using default tag: latest
latest: Pulling from ethack/tht
Digest: sha256:ef98d36e379fb0f2d9537c39b9e53fcb8f349e2cbde9d9d37eb15d4299e0ac41
Status: Image is up to date for ethack/tht:latest
docker.io/ethack/tht:latest
Self-updating THT script...
</code></pre><h1 id=advantages>Advantages</h1><h2 id=simplicity>Simplicity</h2><p>Here is an example of the power of THT. Let&rsquo;s say your goal is to find a trend or anomaly in traffic to <em>cloudfront.net</em>.</p><p>The following command searches Zeek <code>ssl.log</code> files (compressed or not) for all events going to <em>cloudfront.net</em>. It then pulls out the timestamp, converts it to a date, and counts the frequency of events per day. Finally, it displays a bar graph of the result.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>filter --ssl cloudfront.net | chop ts | ts2 date | freq | plot-bar 
</code></pre></div><p><strong>Result:</strong></p><pre><code>      ┌────────────────────────────────────────────────────────────────────────────────────────────┐
475620┤                                                               █████████████▌               │
      │                                                               █████████████▌               │
      │                                                               █████████████▌               │
      │                                                               █████████████▌               │
396350┤                                                               █████████████▌               │
      │                                                               █████████████▌               │
      │                                                               █████████████▌               │
      │                                                               █████████████▌               │
317080┤                                                               █████████████▌               │
      │                                                               █████████████▌               │
      │                                                               █████████████▌               │
      │                                                               █████████████▌               │
237810┤                                                               █████████████▌               │
      │                                                               █████████████▌  ▄▄▄▄▄▄▄▄▄▄▄▄▄│
      │                                                               █████████████▌  █████████████│
      │                                                               █████████████▌  █████████████│
      │                                                               █████████████▌  █████████████│
158540┤                                                               █████████████▌  █████████████│
      │                                                               █████████████▌  █████████████│
      │                                               ▐████████████▌  █████████████▌  █████████████│
      │                                               ▐████████████▌  █████████████▌  █████████████│
 79270┤                                               ▐████████████▌  █████████████▌  █████████████│
      │                                               ▐████████████▌  █████████████▌  █████████████│
      │                                               ▐████████████▌  █████████████▌  █████████████│
      │                               ▗▄▄▄▄▄▄▄▄▄▄▄▄▖  ▐████████████▌  █████████████▌  █████████████│
     0┤▄▄▄▄▄▄▄▄▄▄▄▄▄  ▗▄▄▄▄▄▄▄▄▄▄▄▄▄  ▐████████████▌  ▐████████████▌  █████████████▌  █████████████│
      └──────┬───────────────┬───────────────┬──────────────┬───────────────┬───────────────┬──────┘
         2021-06-21      2021-06-22      2021-06-23     2021-06-24      2021-06-25      2021-06-26  
[y] Count                                           [x]                                             
</code></pre><p>Compare this to a (rougly) equivalent command without THT. It&rsquo;s doable, but you have to be fluent in quite a few builtin Linux tools, as well as their various flags, and how to escape special characters. After all that you get the same information, but you have to compare relative size of numbers in the text output rather than looking at an graph.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>zgrep -hF cloudfront.net */ssl* | cut -d<span style=color:#e6db74>$&#39;\t&#39;</span> -f1 | sed <span style=color:#e6db74>&#39;s/^/@/&#39;</span> | date -Idate -f - | sort -nr | uniq -c
</code></pre></div><p><strong>Result:</strong></p><pre><code>   2910 2021-06-21
   3326 2021-06-22
  19308 2021-06-23
 126939 2021-06-24
 475620 2021-06-25
 226890 2021-06-26
</code></pre><h2 id=speed>Speed</h2><p>Not only do the tools included in THT remove much of the arcane syntax and boilerplate associated with log parsing, but they are also generally faster.</p><p>In the above example, the THT version took <strong>10.8 seconds</strong>.</p><pre><code>filter --ssl cloudfront.net  64.85s user 5.54s system 670% cpu 10.491 total
chop ts  2.56s user 2.10s system 44% cpu 10.492 total
ts2 date  4.54s user 0.11s system 44% cpu 10.496 total
sort --version-sort --buffer-size=2G  1.26s user 0.11s system 12% cpu 10.809 total
uniq -c  0.05s user 0.01s system 0% cpu 10.808 total
plot-bar  0.07s user 0.02s system 0% cpu 10.871 total
</code></pre><p>And the non-THT version took nearly <strong>3x longer</strong> at <strong>31.3 seconds</strong>.</p><pre><code>zgrep -hF cloudfront.net */ssl*  33.00s user 3.68s system 117% cpu 31.188 total
cut -d$'\t' -f1  1.41s user 0.48s system 6% cpu 31.187 total
sed 's/^/@/'  0.32s user 0.04s system 1% cpu 31.187 total
date -Idate -f -  1.23s user 0.04s system 4% cpu 31.186 total
sort -n  0.56s user 0.05s system 1% cpu 31.306 total
uniq -c  0.06s user 0.00s system 0% cpu 31.305 total                                  
</code></pre><h1 id=complementary-projects>Complementary Projects</h1><p>These are all projects that work well together with THT.</p><ul><li><a href=https://www.elastic.co/elasticsearch/>Elastic</a> / <a href=https://www.elastic.co/kibana/>Kibana</a></li><li><a href=https://github.com/metabase/metabase>Metabase</a></li><li><a href=https://github.com/ml-tooling/ml-workspace>ml-workspace</a></li><li><a href=https://www.datascienceatthecommandline.com/>Data Science at the Command Line</a></li></ul><h2 id=further-resources>Further Resources</h2><ul><li><a href=https://github.com/dbohdan/structured-text-tools>https://github.com/dbohdan/structured-text-tools</a></li></ul></main></div><div id=navigation><a class="nav nav-next" href=/tht/filter/ title=Filter><i class="fa fa-chevron-right"></i></a></div></div><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=/tht/js/clipboard.min.js?1634970669></script><script src=/tht/js/perfect-scrollbar.min.js?1634970669></script><script src=/tht/js/perfect-scrollbar.jquery.min.js?1634970669></script><script src=/tht/js/jquery.svg.pan.zoom.js?1634970669></script><script src=/tht/js/featherlight.min.js?1634970669></script><script src=/tht/js/modernizr.custom-3.6.0.js?1634970669></script><script src=/tht/js/mermaid.min.js?1634970669></script><script>typeof mermaid!='undefined'&&mermaid.mermaidAPI.initialize(Object.assign({securityLevel:"antiscript"},JSON.parse('{ "startOnLoad": true }'),{startOnLoad:!1}))</script><script src=/tht/js/relearn.js?1634970669></script></body></html>